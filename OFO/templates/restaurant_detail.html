<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/restaurant.css') }}">
</head>
{% extends 'layout/base.html' %}


{% block content %}
<div class="container py-4">
    <div class="restaurant-info-block">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="#">Nhà hàng</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ restaurant.restaurant_name }}</li>
            </ol>
        </nav>

        <h1 class="restaurant-title mt-2">{{ restaurant.restaurant_name }}</h1>
        {% if restaurant.category %}
        <p class="text-muted fs-5">{{ restaurant.category.name }}</p>
        {% endif %}

        <div class="restaurant-meta-group mt-3">
            <div class="restaurant-meta-item">
                <i class="bi bi-star-fill text-warning"></i>
                <span>4.4</span>
            </div>
            <div class="restaurant-meta-item">
                <i class="bi bi-clock"></i>
                <span>60 phút</span>
            </div>
            <div class="restaurant-meta-item">
                <i class="bi bi-dot"></i>
                <span>1.155,7 km</span>
            </div>
        </div>

        <div class="restaurant-meta-item mt-3 text-muted">
            <span>Giờ mở cửa</span>
            <strong class="text-dark ms-2">
                Hôm nay
                {% if restaurant.open_time and restaurant.close_time %}
                {{ restaurant.open_time.strftime('%H:%M') }} - {{ restaurant.close_time.strftime('%H:%M') }}
                {% else %}
                Đang cập nhật
                {% endif %}
            </strong>
        </div>

        <div class="promo-section restaurant-meta-item mt-3">
            <i class="bi bi-tag-fill"></i>
            <span>Tận hưởng ưu đãi</span>
            <a href="#" class="ms-2">Xem chi tiết</a>
        </div>
    </div>
    <div class="category-navbar-wrapper mt-4">
        <div class="category-navbar">

            <!-- Nút cuộn trái -->
            <button id="scroll-left-btn" class="scroll-btn left d-none">
                <i class="bi bi-chevron-left"></i>
            </button>

            <!-- Danh sách các danh mục -->
            <div id="category-nav-list" class="category-nav-list">
                {% if restaurant.dish_groups %}
                {% for group in restaurant.dish_groups %}
                <a href="#group-{{ group.id }}" class="category-nav-item {% if loop.first %}active{% endif %}">{{
                    group.name }}</a>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Nút cuộn phải -->
            <button id="scroll-right-btn" class="scroll-btn right">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- ==== PHẦN HIỂN THỊ SẢN PHẨM ==== -->
    {% if restaurant.dish_groups %}
    {% for group in restaurant.dish_groups %}
    <div id="group-{{ group.id }}" class="menu-section">
        <h2 class="menu-section-title">{{ group.name }}</h2>
        <div class="row g-4">
            {% for dish in group.dishes %}
            <div class="col-lg-4 col-md-6 d-flex">
                <div class="product-card w-100">
                    <div class="product-card-img-wrapper">
                        <img src="{{ dish.image if dish.image else 'https://via.placeholder.com/400x300' }}"
                             alt="{{ dish.name }}">
                    </div>
                    <div class="product-card-body">
                        <h5 class="product-card-title">{{ dish.name }}</h5>
                        <p class="product-card-desc">{{ dish.description }}</p>
                        <div class="product-card-footer">
                            <div class="product-card-price">
                                <div>
                                    {# Định dạng giá tiền cho đẹp #}
                                    <span class="current-price">{{ "{:,.0f}".format(dish.price) }}</span>
                                </div>
                            </div>
                            {# Thêm data-dish-id để JavaScript có thể lấy ID món ăn #}
                            <button class="btn-add-to-cart" data-bs-toggle="offcanvas"
                                    data-bs-target="#productOptionsOffcanvas"
                                    data-dish-id="{{ dish.id }}">+
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            {# Hiển thị nếu một nhóm không có món ăn nào #}
            <p class="text-muted">Chưa có món ăn nào trong mục này.</p>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-center mt-5">Nhà hàng này hiện chưa có thực đơn.</p>
    {% endif %}

    <!-- Nút để mở Offcanvas -->
    <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#productOptionsOffcanvas" aria-controls="productOptionsOffcanvas">
        Mở Tùy chọn sản phẩm
    </button>

    <!-- Offcanvas cho Product Options -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="productOptionsOffcanvas" aria-labelledby="offcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- NỘI DUNG CÓ THỂ CUỘN -->
            <div class="scrollable-content" id="offcanvas-content-wrapper">
                <!-- JS chèn -->
            </div>
        </div>

        <div class="offcanvas-footer d-flex align-items-center justify-content-between">
            <div class="quantity-selector d-flex align-items-center">
                <button class="btn" id="decrease-qty">-</button>
                <input type="text" id="quantity" value="1" readonly>
                <button class="btn" id="increase-qty">+</button>
            </div>
            <button class="btn btn-pink flex-grow-1 ms-3 fw-bold" id="add-to-basket-btn" disabled>Add to Basket
            </button>
        </div>
    </div>
</div>


</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Phần 1: Các biến và phần tử cần thiết ---
        const navList = document.getElementById('category-nav-list');
        const navLinks = document.querySelectorAll('#category-nav-list .category-nav-item');
        const sections = document.querySelectorAll('.menu-section');
        const leftBtn = document.getElementById('scroll-left-btn');
        const rightBtn = document.getElementById('scroll-right-btn');

        // Chiều cao của header và thanh nav để tính toán vị trí cuộn chính xác
        const offsetHeight = 150;

        if (!navList) return; // Thoát nếu không có thanh nav

        // --- Phần 2: Xử lý các nút cuộn trái/phải ---
        if (leftBtn && rightBtn) {
            const scrollAmount = 250;

            function updateButtonVisibility() {
                const maxScroll = navList.scrollWidth - navList.clientWidth;
                leftBtn.classList.toggle('d-none', navList.scrollLeft <= 0);
                rightBtn.classList.toggle('d-none', navList.scrollLeft >= maxScroll - 1);
            }

            leftBtn.addEventListener('click', () => navList.scrollBy({ left: -scrollAmount }));
            rightBtn.addEventListener('click', () => navList.scrollBy({ left: scrollAmount }));
            navList.addEventListener('scroll', updateButtonVisibility);
            setTimeout(updateButtonVisibility, 100);
        }

        // --- Phần 3: Xử lý highlight tự động KHI CUỘN trang ---
        function onWindowScroll() {
            let currentSectionId = '';

            // Tìm xem section nào đang ở trên cùng của màn hình
            sections.forEach(section => {
                const sectionTop = section.offsetTop - offsetHeight;
                if (window.pageYOffset >= sectionTop) {
                    currentSectionId = '#' + section.id;
                }
            });

            // Highlight link tương ứng trong thanh nav
            navLinks.forEach(link => {
                link.classList.remove('active'); // Xóa active khỏi tất cả
                if (link.getAttribute('href') === currentSectionId) {
                    link.classList.add('active'); // Thêm active cho link đúng
                    // Tự động cuộn thanh nav để link active luôn được nhìn thấy
                    link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
        }

        // Gán sự kiện cuộn cho toàn bộ cửa sổ
        window.addEventListener('scroll', onWindowScroll);


        // --- Phần 4: Xử lý cuộn mượt mà KHI CLICK vào một mục trên nav ---
        navLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault(); // Ngăn hành vi nhảy trang mặc định

                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);

                if (targetSection) {
                    const topPos = targetSection.offsetTop - (offsetHeight - 50); // Bớt đi một chút để không bị che
                    window.scrollTo({
                        top: topPos,
                        behavior: 'smooth'
                    });
                }
            });
        });

    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const offcanvasElement = document.getElementById('productOptionsOffcanvas');
        const offcanvasContentWrapper = document.getElementById('offcanvas-content-wrapper');
        const addToBasketBtn = document.getElementById('add-to-basket-btn');
        const quantityInput = document.getElementById('quantity');
        const decreaseBtn = document.getElementById('decrease-qty');
        const increaseBtn = document.getElementById('increase-qty');

        // Hàm định dạng tiền tệ
        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN').format(value);
        }

        // Hàm này sẽ khởi tạo lại toàn bộ logic tính toán cho offcanvas
        function initializeOffcanvasLogic(dishData) {
            const optionInputs = offcanvasContentWrapper.querySelectorAll('input[type="radio"], input[type="checkbox"]');

            // Hàm chính để cập nhật tổng giá tiền
            function updateTotal() {
                // 1. Lấy giá cơ bản của món ăn từ dữ liệu API
                let basePrice = parseFloat(dishData.price);

                // 2. Tính tổng giá các tùy chọn đã chọn
                let optionsPrice = 0;
                optionInputs.forEach(input => {
                    if (input.checked) {
                        optionsPrice += parseFloat(input.value);
                    }
                });

                // 3. Lấy số lượng
                const quantity = parseInt(quantityInput.value);

                // 4. Tính tổng cuối cùng
                const total = (basePrice + optionsPrice) * quantity;

                // 5. Cập nhật nội dung nút "Thêm vào giỏ hàng"
                addToBasketBtn.textContent = `Thêm vào giỏ - ${formatCurrency(total)} ₫`;
                addToBasketBtn.disabled = false;
            }

            // Gán sự kiện cho tất cả các input tùy chọn (radio, checkbox)
            optionInputs.forEach(input => input.addEventListener('change', updateTotal));

            // Gán sự kiện cho nút tăng/giảm số lượng
            increaseBtn.onclick = () => {
                quantityInput.value = parseInt(quantityInput.value) + 1;
                updateTotal();
            };
            decreaseBtn.onclick = () => {
                let currentQty = parseInt(quantityInput.value);
                if (currentQty > 1) {
                    quantityInput.value = currentQty - 1;
                    updateTotal();
                }
            };

            // Gọi updateTotal() một lần để tính giá ban đầu
            updateTotal();
        }

        // Lắng nghe sự kiện khi offcanvas sắp được hiển thị
        offcanvasElement.addEventListener('show.bs.offcanvas', async function (event) {
            const button = event.relatedTarget;
            const dishId = button.dataset.dishId;

            if (!dishId) return;

            // Reset số lượng về 1
            quantityInput.value = 1;
            // Vô hiệu hóa nút thêm vào giỏ hàng trong khi tải
            addToBasketBtn.textContent = 'Đang tải...';
            addToBasketBtn.disabled = true;

            // Hiển thị trạng thái loading
            offcanvasContentWrapper.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            try {
                // Gọi API để lấy chi tiết món ăn
                const response = await fetch(`/api/dish/${dishId}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                // --- BƯỚC 1: XÂY DỰNG HTML ĐỘNG ---
                let html = `
                    <div class="product-main-info d-flex align-items-start mb-3">
                        <img src="${data.image || 'https://via.placeholder.com/100'}" class="product-image me-3" alt="${data.name}">
                        <div class="flex-grow-1">
                            <h5 class="fw-bold mb-1">${data.name}</h5>
                            <p class="small text-muted">${data.description || ''}</p>
                        </div>
                        <div class="text-end ms-2 flex-shrink-0">
                            <span class="fw-bold fs-5">${formatCurrency(data.price)}</span>
                        </div>
                    </div>
                `;

                data.option_groups.forEach(group => {
                    html += `
                        <div class="options-section">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <h6 class="fw-bold mb-0">${group.name}</h6>
                                    ${group.max_selection ? `<small class="text-muted">Tùy chọn, tối đa ${group.max_selection}</small>` : ''}
                                </div>
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">${group.mandatory ? 'Bắt buộc' : 'Tùy chọn'}</span>
                            </div>
                    `;
                    group.options.forEach(option => {
                        const inputType = group.max_selection === 1 ? 'radio' : 'checkbox';
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="${inputType}" name="group-${group.id}" id="option-${option.id}" value="${option.price_change}">
                                    <label class="form-check-label w-100" for="option-${option.id}">${option.name}</label>
                                </div>
                                <span class="fw-normal">+${formatCurrency(option.price_change)}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                });

                // --- THÊM LẠI MỤC GHI CHÚ BỊ MẤT ---
                html += `
                    <div class="options-section">
                        <div class="mb-2">
                            <label for="specialInstructions" class="form-label">
                                <strong class="me-2">Ghi chú</strong>
                                <small class="text-muted">Tùy chọn</small>
                            </label>
                            <input type="text" class="form-control" id="specialInstructions" placeholder="Ví dụ: Ít đường, không đá...">
                        </div>
                    </div>
                `;

                // Cập nhật nội dung offcanvas
                offcanvasContentWrapper.innerHTML = html;

                // --- BƯỚC 2: GỌI HÀM ĐỂ GÁN LẠI LOGIC TÍNH TOÁN ---
                initializeOffcanvasLogic(data);

            } catch (error) {
                console.error('Failed to fetch dish details:', error);
                offcanvasContentWrapper.innerHTML = '<p class="text-center text-danger">Không thể tải được chi tiết món ăn. Vui lòng thử lại.</p>';
            }
        });
    });
</script>
{% endblock %}