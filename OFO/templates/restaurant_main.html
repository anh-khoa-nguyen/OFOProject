<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/restaurant.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
{% extends 'layout/base.html' %}

{% block content %}
<div class="container py-4">

    <div class="restaurant-info-block">
        <div class="restaurant-management-nav">
            <ul>
                <li>
                    <!-- Trang 'Thực đơn' đang active -->
                    <a href="{{ url_for('home', restaurant_id=restaurant.id) }}" class="active">
                        <i class="fas fa-utensils"></i>
                        <span>Thực Đơn</span>
                    </a>
                </li>
                <li>
                    <a href="#"> <!-- Thay bằng url_for('...') của bạn -->
                        <i class="fas fa-receipt"></i>
                        <span>Đơn Hàng</span>
                    </a>
                </li>
                <li>
                    <a href="#"> <!-- Thay bằng url_for('...') của bạn -->
                        <i class="fas fa-chart-line"></i>
                        <span>Doanh Thu</span>
                    </a>
                </li>
                <li>
                    <a href="#"> <!-- Thay bằng url_for('...') của bạn -->
                        <i class="fas fa-tags"></i>
                        <span>Khuyến Mãi</span>
                    </a>
                </li>
            </ul>
        </div>

        <h1 class="restaurant-title mt-2">{{ restaurant.restaurant_name }}</h1>
        <p class="text-muted fs-5">Trà sữa</p>

        <div class="restaurant-meta-group mt-3">
            <div class="restaurant-meta-item">
                <i class="bi bi-star-fill text-warning"></i>
                <span>4.4</span>
            </div>
            <div class="restaurant-meta-item">
                <i class="bi bi-clock"></i>
                <span>60 phút</span>
            </div>
            <div class="restaurant-meta-item">
                <i class="bi bi-dot"></i>
                <span>1.155,7 km</span>
            </div>
        </div>

        <div class="restaurant-meta-item mt-3 text-muted">
            <span>Giờ mở cửa</span>
            <strong class="text-dark ms-2">Hôm nay {{ restaurant.open_time.strftime('%H:%M') }} - {{
                restaurant.close_time.strftime('%H:%M') }}</strong>
        </div>

        <div class="promo-section restaurant-meta-item mt-3">
            <i class="bi bi-tag-fill"></i>
            <span>Tận hưởng ưu đãi</span>
            <a href="#" class="ms-2">Xem chi tiết</a>
        </div>
    </div>
    <div class="category-navbar-wrapper mt-4">
        <div class="category-navbar">

            <!-- Nút cuộn trái -->
            <button id="scroll-left-btn" class="scroll-btn left d-none">
                <i class="bi bi-chevron-left"></i>
            </button>

            <!-- Danh sách các danh mục -->
            <div id="category-nav-list" class="category-nav-list">
                <button id="btn_open_modal_dishgroup" class="btn-add-to-dish_group" title="Thêm nhóm món">+</button>
                {% for group in dish_groups %}
                <a href="#section-{{ group.name | lower | replace(' ', '-') }}" class="category-nav-item">
                    {{ group.name }}
                </a>
                {% endfor %}
            </div>
            <!-- Nút cuộn phải -->
            <button id="scroll-right-btn" class="scroll-btn right">
                <i class="bi bi-chevron-right"></i>
            </button>

        </div>

    </div>
    <div class="category-navbar-wrapper mt-3">
        <div class="category-navbar">

            <!-- Nút cuộn trái (ID mới) -->
            <button id="scroll-left-btnn" class="scroll-btn left d-none">
                <i class="bi bi-chevron-left"></i>
            </button>

            <!-- Danh sách các Dish_option_Group (ID mới) -->
            <div id="option-group-nav-list" class="category-nav-list">
                <button class="btn-add-to-dish_group" title="Tạo Nhóm Tùy Chọn Mới"
                        type="button"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#dynamicFormOffcanvas">
                    +
                </button>

                {# Vòng lặp này sẽ hiển thị tất cả các nhóm tùy chọn bạn đã tạo #}
                {# Giả sử bạn truyền một biến `option_groups` từ backend #}
                {% for option_group in dish_option_group %}
                <a href="#" class="category-nav-item edit-option-group-trigger"
                   role="button"
                   data-bs-toggle="offcanvas"
                   data-bs-target="#editOptionGroupOffcanvas"
                   data-group-id="{{ option_group.id }}">
                    {{ option_group.name }}
                </a>
                {% endfor %}
            </div>

            <!-- Nút cuộn phải (ID mới) -->
            <button id="scroll-right-btnn" class="scroll-btn right">
                <i class="bi bi-chevron-right"></i>
            </button>

        </div>
    </div>

    <!-- ==== BẮT ĐẦU PHẦN HIỂN THỊ SẢN PHẨM ==== -->
    {% for group in dish_groups %}
    <div id="section-{{ group.name | lower | replace(' ', '-') }}" class="menu-section">
        <h2 class="menu-section-title">{{ group.name }}
            <button class="btn-delete-group" title="Xoá nhóm món" data-id="{{ group.id }}">
                <i class="fas fa-minus"></i>

            </button>
        </h2>
        <!-- Nút Xoá -->


        <div class="row g-4">
            {% for dish in group.dishes %}
            <div class="col-lg-4 col-md-6 d-flex">
                <div class="product-card w-100">
                    <button class="btn-delete-dish position-absolute top-0 end-0 m-2"
                            data-dish-id="{{ dish.id }}"
                            title="Xóa món ăn">
                        <i class="fas fa-xmark"></i>
                    </button>

                    <div class="product-card-img-wrapper">
                        <img src="{{ dish.image if dish.image else 'https://example.com/default.jpg' }}" alt="{{ dish.name }}">
                    </div>
                    <div class="product-card-body">
                        <h5 class="product-card-title">{{ dish.name }}</h5>
                        <p class="product-card-desc">{{ dish.description }}</p>
                        <div class="product-card-footer">
                            <div class="product-card-price">
                                <span class="current-price">{{ '{:,.0f}'.format(dish.price) }} đ</span>
                            </div>
                            <button class="btn-add-to-cart"
                                    data-id="{{ dish.id }}"
                                    data-name="{{ dish.name }}"
                                    data-desc="{{ dish.description }}"
                                    data-price="{{ dish.price }}"
                                    data-image="{{ dish.image }}"
                                    data-group="{{ dish.dish_group_id }}"
                            >
                                <i class="fas fa-edit"></i>
                            </button>

                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <button type="button" class="add-dish-btn"
                data-group-id="{{ group.id }}">➕ Thêm món ăn
        </button>
    </div>
    {% endfor %}
    <!-- THE MODAL CHO DISHGROUP -->
    <div id="modal_dishgroup" class="modal">
        <!-- Lớp phủ màu đen phía sau (class này có thể dùng chung cho các modal khác) -->
        <div class="modal-overlay"></div>

        <!-- Nội dung của Modal (class này có thể dùng chung) -->
        <div class="modal-content">
            <button class="close-modal" title="Đóng">×</button>
            <h2>Thêm Nhóm Món Ăn Mới</h2>

            <!-- Form để gửi dữ liệu, với ID cụ thể -->
            <form id="form_add_dishgroup">
                <div class="form-group">
                    <label for="input_dishgroup_name">Tên nhóm món</label>
                    <input type="text" id="input_dishgroup_name" name="name" required placeholder="Ví dụ: Món Khai Vị">
                </div>


                <button type="submit" class="btn-submit">Lưu Nhóm Mới</button>
            </form>
        </div>
    </div>
    <!-- Nút để mở Offcanvas -->

    <!--THÊM MÓN ĂN - MODAL -->
    <div id="modal_add_dish" class="modal">
        <!-- Lớp phủ màu đen phía sau (dùng chung class 'modal-overlay') -->
        <div class="modal-overlay"></div>

        <!-- Nội dung của Modal (dùng chung class 'modal-content') -->
        <div class="modal-content">
            <!-- Nút đóng (dùng chung class 'close-modal') -->
            <button class="close-modal" title="Đóng">×</button>


            <h2>Thêm Món Ăn Mới</h2>

            <!-- Form để gửi dữ liệu, với ID cụ thể là 'form_add_dish' -->
            <form id="form_add_dish" enctype="multipart/form-data">
                <!-- TRƯỜNG ẨN: Rất quan trọng để biết món ăn này thuộc nhóm nào -->
                <input type="hidden" id="dish_group_id_input" name="dish_group_id">
                <input type="hidden" name="restaurant_id" value="1"> <!-- Giả sử ID nhà hàng là 1 -->

                <div class="form-group">
                    <label for="input_dish_name">Tên món ăn</label>
                    <input type="text" id="input_dish_name" name="name" required placeholder="Ví dụ: Cơm Tấm Sườn">
                </div>

                <div class="form-group">
                    <label for="input_dish_description">Mô tả (không bắt buộc)</label>
                    <input type="text" id="input_dish_description" name="description"
                           placeholder="Ví dụ: Sườn nướng mật ong">
                </div>

                <div class="form-group">
                    <label for="input_dish_price">Giá</label>
                    <input type="number" id="input_dish_price" name="price" required placeholder="Ví dụ: 35000">
                </div>
                <div class="form-group">
                    <label class="form-label fw-bold">Thêm vào các nhóm tùy chọn</label>
                    <div id="add-dish-options-container" class="mt-2">
                        {% for group in dish_option_group %}
                        <div class="form-check">
                            <!-- `name` phải là "option_group_ids" (số nhiều) -->
                            <input class="form-check-input" type="checkbox"
                                   name="option_group_ids"
                                   value="{{ group.id }}"
                                   id="add-dish-option-{{ group.id }}">
                            <label class="form-check-label" for="add-dish-option-{{ group.id }}">
                                {{ group.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-group">
                    <label for="input_dish_image">Hình ảnh</label>
                    <input type="file" id="input_dish_image" name="image" accept="image/*">
                </div>

                <button type="submit" class="btn-submit">Lưu Món Ăn</button>
            </form>
        </div>
    </div>
    <!--SỬA MÓN ĂN -->
    <div id="modal_edit_dish" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button class="close-modal">×</button>
            <h2>Sửa Món Ăn</h2>
            <form id="form_edit_dish" enctype="multipart/form-data">
                <input type="hidden" name="dish_id" id="edit_dish_id">
                <input type="hidden" name="restaurant_id" value="1">
                <input type="hidden" name="dish_group_id" id="edit_group_id">

                <div class="form-group">
                    <label>Tên món ăn</label>
                    <input type="text" name="name" id="edit_name" required>
                </div>

                <div class="form-group">
                    <label>Mô tả</label>
                    <input type="text" name="description" id="edit_description">
                </div>

                <div class="form-group">
                    <label>Giá</label>
                    <input type="number" name="price" id="edit_price" required>
                </div>
                <div class="form-group">
                    <label class="form-label fw-bold">Các nhóm tùy chọn liên kết</label>
                    <div id="edit-dish-options-container" class="mt-2">
                        {% for group in dish_option_group %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="option_group_ids"
                                   value="{{ group.id }}"
                                   id="edit-dish-option-{{ group.id }}">
                            <!-- SỬA LẠI `for` Ở ĐÂY để khớp với id ở trên -->
                            <label class="form-check-label" for="edit-dish-option-{{ group.id }}">
                                {{ group.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-group">
                    <label>Hình ảnh mới (tùy chọn)</label>
                    <input type="file" name="image" accept="image/*">
                </div>

                <button type="submit" class="btn-submit">Lưu thay đổi</button>
            </form>
        </div>
    </div>
    <!-- ==== OFFCANVAS ĐỂ TẠO MỚI DISH OPTION GROUP ==== -->
    <div class="offcanvas offcanvas-end" style="--bs-offcanvas-width: 500px;" tabindex="-1" id="dynamicFormOffcanvas"
         aria-labelledby="offcanvasLabel">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="offcanvasLabel">Tạo Nhóm Tùy Chọn Mới</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <form id="dynamicForm">
                <!-- Tên nhóm -->
                <div class="mb-4">
                    <label for="groupName" class="form-label fw-bold">Tên nhóm tùy chọn</label>
                    <input type="text" class="form-control" id="groupName" placeholder="Ví dụ: Topping, Chọn Size...">
                </div>
                <div class="mb-3">
                    <label for="maxSelection" class="form-label">Lựa chọn tối đa</label>
                    <input type="number" class="form-control" id="maxSelection" min="1"
                           placeholder="Bỏ trống nếu không giới hạn">
                </div>

                <!-- 3. Bắt buộc (TRƯỜNG MỚI CHO `mandatory`) -->
                <div class="form-check form-switch p-0">
                    <label class="form-check-label" for="isMandatory">Bắt buộc</label>
                    <input class="form-check-input" style="margin: auto" type="checkbox" role="switch" id="isMandatory">
                </div>
                <hr>

                <!-- Các lựa chọn -->
                <h6 class="fw-bold mb-3">Các Lựa Chọn Trong Nhóm</h6>
                <div id="dynamicInputsContainer">
                    <!-- JavaScript sẽ chèn các "Thẻ Lựa Chọn" vào đây -->
                </div>

                <!-- Nút thêm thẻ mới -->
                <button type="button" class="btn w-100 mt-2" id="addInputButton">
                    <i class="fas fa-plus"></i> Thêm Lựa Chọn
                </button>
            </form>
        </div>
        <div class="offcanvas-footer p-3 border-top bg-light">
            <button type="submit" class="btn btn-success w-100 fw-bold" form="dynamicForm">
                Lưu
            </button>
        </div>
    </div>
</div>
<!-- OFF-CANVAS "SỬA" - ID MỚI, CLASS GIỐNG HỆT OFF-CANVAS "TẠO" -->
<div class="offcanvas offcanvas-end" style="--bs-offcanvas-width: 500px;" tabindex="-1"
     id="editOptionGroupOffcanvas"
     aria-labelledby="editOffcanvasLabel">

    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="editOffcanvasLabel">Chỉnh Sửa Nhóm Tùy Chọn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body">
        <form id="editOptionGroupForm">
            <!-- Input ẩn để lưu ID của group đang sửa -->
            <input type="hidden" id="editGroupId">

            <!-- Các trường input -->
            <div class="mb-4">
                <label for="editGroupName" class="form-label fw-bold">Tên nhóm tùy chọn</label>
                <input type="text" class="form-control" id="editGroupName" required>
            </div>
            <div class="mb-3">
                <label for="editGroupMax" class="form-label">Lựa chọn tối đa</label>
                <input type="number" class="form-control" id="editGroupMax" min="1"
                       placeholder="Bỏ trống nếu không giới hạn">
            </div>
            <div class="form-check form-switch p-0">
                <label class="form-check-label" for="editGroupMandatory">Bắt buộc</label>
                <input class="form-check-input" style="margin: auto" type="checkbox" role="switch"
                       id="editGroupMandatory">
            </div>
            <hr>

            <h6 class="fw-bold mb-3">Các Lựa Chọn Trong Nhóm</h6>
            <div id="editOptionsContainer">
                <!-- JavaScript sẽ điền các lựa chọn vào đây -->
            </div>

            <!-- Nút thêm lựa chọn mới -->
            <button type="button" class="btn   w-100 mt-2" id="addAnotherOptionBtn">
                <i class="fas fa-plus"></i> Thêm Lựa Chọn Khác
            </button>
        </form>
    </div>

    <div class="offcanvas-footer p-3 border-top bg-light">
        <!-- Nút submit trỏ đến form "Sửa" bằng thuộc tính `form` -->
        <button type="submit" class="btn btn-pink w-100 fw-bold" form="editOptionGroupForm">
            Lưu Thay Đổi
        </button>
        <button type="button" style=" margin-top: 10px" class="btn btn-outline-danger w-100 fw-bold "
                id="deleteGroupInsideFormBtn">
            Xóa
        </button>

    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function reformatNumberInput(inputElement) {
            let value = inputElement.value;
            if (value.startsWith('0') && value.length > 1) {
                inputElement.value = Number(value);
            }
        }
        document.body.addEventListener('input', function(event) {
            if (event.target.matches('input[name="option_price"]') || event.target.matches('.edit-option-price')) {
                reformatNumberInput(event.target);
            }
        });

    });
    document.addEventListener('DOMContentLoaded', function () {
        // --- Phần 1: Các biến và phần tử cần thiết ---
        const navList = document.getElementById('category-nav-list');
        const navLinks = document.querySelectorAll('#category-nav-list .category-nav-item');
        const navListe = document.getElementById('option-group-nav-list');
        const sections = document.querySelectorAll('.menu-section');
        const leftBtn = document.getElementById('scroll-left-btn');
        const rightBtn = document.getElementById('scroll-right-btn');
        const leftBtnn = document.getElementById('scroll-left-btnn');
        const rightBtnn = document.getElementById('scroll-right-btnn');

        // Chiều cao của header và thanh nav để tính toán vị trí cuộn chính xác
        const offsetHeight = 150;

        if (!navList) return; // Thoát nếu không có thanh nav

        // --- Phần 2: Xử lý các nút cuộn trái/phải ---
        if (leftBtn && rightBtn) {
            const scrollAmount = 250;

            function updateButtonVisibility() {
                const maxScroll = navList.scrollWidth - navList.clientWidth;
                leftBtn.classList.toggle('d-none', navList.scrollLeft <= 0);
                rightBtn.classList.toggle('d-none', navList.scrollLeft >= maxScroll - 1);
            }

            leftBtn.addEventListener('click', () => navList.scrollBy({ left: -scrollAmount }));
            rightBtn.addEventListener('click', () => navList.scrollBy({ left: scrollAmount }));
            navList.addEventListener('scroll', updateButtonVisibility);
            setTimeout(updateButtonVisibility, 100);
        }
        if (leftBtnn && rightBtnn) {
            const scrollAmountt = 250;

            function updateButtonVisibilityy() {
                const maxScrolll = navListe.scrollWidth - navListe.clientWidth;
                leftBtnn.classList.toggle('d-none', navListe.scrollLeft <= 0);
                rightBtnn.classList.toggle('d-none', navListe.scrollLeft >= maxScrolll - 1);
            }

            leftBtnn.addEventListener('click', () => navListe.scrollBy({ left: -scrollAmountt }));
            rightBtnn.addEventListener('click', () => navListe.scrollBy({ left: scrollAmountt }));
            navListe.addEventListener('scroll', updateButtonVisibilityy);
            setTimeout(updateButtonVisibilityy, 100);
        }

        // --- Phần 3: Xử lý highlight tự động KHI CUỘN trang ---
        function onWindowScroll() {
            let currentSectionId = '';

            // Tìm xem section nào đang ở trên cùng của màn hình
            sections.forEach(section => {
                const sectionTop = section.offsetTop - offsetHeight;
                if (window.pageYOffset >= sectionTop) {
                    currentSectionId = '#' + section.id;
                }
            });

            // Highlight link tương ứng trong thanh nav
            navLinks.forEach(link => {
                link.classList.remove('active'); // Xóa active khỏi tất cả
                if (link.getAttribute('href') === currentSectionId) {
                    link.classList.add('active'); // Thêm active cho link đúng
                    // Tự động cuộn thanh nav để link active luôn được nhìn thấy
                    link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
        }

        // Gán sự kiện cuộn cho toàn bộ cửa sổ
        window.addEventListener('scroll', onWindowScroll);


        // --- Phần 4: Xử lý cuộn mượt mà KHI CLICK vào một mục trên nav ---
        navLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault(); // Ngăn hành vi nhảy trang mặc định

                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);

                if (targetSection) {
                    const topPos = targetSection.offsetTop - (offsetHeight - 50); // Bớt đi một chút để không bị che
                    window.scrollTo({
                        top: topPos,
                        behavior: 'smooth'
                    });
                }
            });
        });

    });
document.addEventListener('DOMContentLoaded', function () {

        // --- 1. Lấy các phần tử của thanh Tùy Chọn bằng ID riêng của nó ---
        const optionsNavList = document.getElementById('option-group-nav-list');
        const optionsLeftBtn = document.getElementById('scroll-left-options-btn');
        const optionsRightBtn = document.getElementById('scroll-right-options-btn');

        // Nếu không tìm thấy một trong các phần tử, thoát để không gây lỗi
        if (!optionsNavList || !optionsLeftBtn || !optionsRightBtn) {
            return;
        }

        // --- 2. Xử lý các nút cuộn trái/phải ---
        const scrollAmount = 250;

        // Hàm này có tên riêng để không xung đột với hàm của script cũ
        function updateOptionsButtons() {
            const maxScroll = optionsNavList.scrollWidth - optionsNavList.clientWidth;

            // Ẩn/hiện các nút của thanh Tùy Chọn
            optionsLeftBtn.classList.toggle('d-none', optionsNavList.scrollLeft <= 0);
            optionsRightBtn.classList.toggle('d-none', optionsNavList.scrollLeft >= maxScroll - 1);
        }

        // Gán sự kiện click cho các nút của thanh Tùy Chọn
        optionsLeftBtn.addEventListener('click', () => optionsNavList.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
        optionsRightBtn.addEventListener('click', () => optionsNavList.scrollBy({ left: scrollAmount, behavior: 'smooth' }));

        // Gán sự kiện scroll cho thanh Tùy Chọn
        optionsNavList.addEventListener('scroll', updateOptionsButtons);

        // SỬA LỖI HIỂN THỊ:
        // Dùng ResizeObserver là cách đáng tin cậy nhất để theo dõi kích thước
        // và cập nhật nút đúng thời điểm, thay vì dùng setTimeout.
        const observer = new ResizeObserver(updateOptionsButtons);
        observer.observe(optionsNavList);
    });
</script>
<script>

    const addInputButton = document.getElementById('addInputButton');
    const dynamicInputsContainer = document.getElementById('dynamicInputsContainer');
    const dynamicForm = document.getElementById('dynamicForm');

    // --- HÀM TẠO RA MỘT "THẺ LỰA CHỌN" MỚI ---
    function createNewInputRow() {
        const cardWrapper = document.createElement('div');
        // Gán class để CSS có thể áp dụng style
        cardWrapper.classList.add('option-card');

        // Nội dung HTML cho cả thẻ
        cardWrapper.innerHTML = `
            <!-- Nút xóa nằm ở góc -->
            <button type="button" class="btn-delete-option" title="Xóa lựa chọn này">
                <i class="fas fa-times"></i>
            </button>

            <!-- Bố cục 2 cột cho Tên và Giá -->
            <div class="row g-3">
                <!-- Cột 1: Tên lựa chọn -->
                <div class="col-md-7">
                    <label class="form-label">Tên lựa chọn</label>
                    <input type="text" class="form-control form-control-sm" name="option_name" required>
                </div>

                <!-- Cột 2: Giá thêm -->
                <div class="col-md-5">
                    <label class="form-label">Giá thêm (đ)</label>
                    <input type="number" class="form-control form-control-sm" name="option_price" value="0" min="0" required>
                </div>
            </div>
        `;
        dynamicInputsContainer.appendChild(cardWrapper);
    }


    // --- GÁN SỰ KIỆN ---

    // 1. Click để thêm thẻ mới
    addInputButton.addEventListener('click', createNewInputRow);

    // 2. Click để xóa thẻ
    dynamicInputsContainer.addEventListener('click', function(event) {
        const deleteButton = event.target.closest('.btn-delete-option');
        if (deleteButton) {
            // Tìm đến thẻ cha gần nhất có class .option-card và xóa nó
            deleteButton.closest('.option-card').remove();
        }
    });

    // 3. Submit form để thu thập dữ liệu
    dynamicForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const data = {
            name: document.getElementById('groupName').value.trim(),
            options: []
        };

        const allOptionCards = dynamicInputsContainer.querySelectorAll('.option-card');
        allOptionCards.forEach(card => {
            const name = card.querySelector('input[name="option_name"]').value.trim();
            const price = parseFloat(card.querySelector('input[name="option_price"]').value);
            if (name) {
                data.options.push({ name, price });
            }
        });

        if (!data.name || data.options.length === 0) {
            alert("Vui lòng điền đầy đủ tên nhóm và ít nhất một lựa chọn.");
            return;
        }

        console.log('Dữ liệu dạng thẻ sẽ được gửi đi:');
        console.log(JSON.stringify(data, null, 2));
    });

    // Tự động tạo thẻ đầu tiên
    createNewInputRow();
    //Thêm DISH_OPTION_GROUP
 dynamicForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // 1. Thu thập dữ liệu từ form
            const data = {
                restaurant_id: "{{ restaurant.id }}", // Lấy ID nhà hàng từ template
                name: document.getElementById('groupName').value.trim(),
                max: document.getElementById('maxSelection').value ? parseInt(document.getElementById('maxSelection').value) : null,
                mandatory: document.getElementById('isMandatory').checked,
                options: []
            };

            const allOptionCards = dynamicInputsContainer.querySelectorAll('.option-card');
            allOptionCards.forEach(card => {
                const name = card.querySelector('input[name="option_name"]').value.trim();
                const price = parseFloat(card.querySelector('input[name="option_price"]').value);
                if (name) {
                    data.options.push({ name, price });
                }
            });

            if (!data.name || data.options.length === 0) {
                alert("Vui lòng điền đầy đủ tên nhóm và ít nhất một lựa chọn.");
                return;
            }

            // 2. Gửi dữ liệu đến API bằng fetch
            fetch('/api/add_option_group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                // 3. Xử lý kết quả trả về từ server
                if (result.success) {
                    alert('✅ ' + result.message);

                    // Tải lại trang để cập nhật danh sách
                    location.reload();
                } else {
                    alert('❌ Lỗi: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Lỗi khi gửi dữ liệu:', error);
                alert('❌ Đã xảy ra lỗi mạng. Vui lòng thử lại.');
            });
  });


</script>
<script>
    //SỬA NHÓM MÓN
document.addEventListener('DOMContentLoaded', function () {

    const editOffcanvasEl = document.getElementById('editOptionGroupOffcanvas');

    // Nếu không có offcanvas "Sửa" trên trang thì dừng lại
    if (!editOffcanvasEl) {
        return;
    }

    // --- 1. Lấy các phần tử DOM của form "Sửa" ---
    const editForm = document.getElementById('editOptionGroupForm');
    const editGroupIdInput = document.getElementById('editGroupId');
    const editGroupNameInput = document.getElementById('editGroupName');
    const editGroupMaxInput = document.getElementById('editGroupMax');
    const editGroupMandatoryInput = document.getElementById('editGroupMandatory');
    const editOptionsContainer = document.getElementById('editOptionsContainer');
    const addAnotherOptionBtn = document.getElementById('addAnotherOptionBtn');

    // --- 2. Hàm tái sử dụng để tạo một dòng tùy chọn ---
    const createEditOptionRow = (option = { name: '', price: 0 }) => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.innerHTML = `
            <button type="button" class="btn-delete-option" title="Xóa"><i class="fas fa-times"></i></button>
            <div class="row g-3">
                <div class="col-md-7">
                    <label class="form-label">Tên</label>
                    <input type="text" class="form-control form-control-sm edit-option-name" value="${option.name}" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Giá</label>
                    <input type="number" class="form-control form-control-sm edit-option-price" value="${option.price}" min="0" required>
                </div>
            </div>`;
        card.querySelector('.btn-delete-option').addEventListener('click', () => card.remove());
        return card;
    };

    // --- 3. Lắng nghe sự kiện khi offcanvas CHUẨN BỊ MỞ (Fetch Data) ---
    editOffcanvasEl.addEventListener('show.bs.offcanvas', async function (event) {
        // Dọn dẹp form và hiển thị trạng thái tải
        editForm.reset();
        editOptionsContainer.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...</p>';

        const triggerLink = event.relatedTarget;
        const groupId = triggerLink.dataset.groupId;

        try {
            const response = await fetch(`/api/option-group/${groupId}`);
            if (!response.ok) {
                throw new Error(`Lỗi máy chủ: ${response.statusText}`);
            }
            const data = await response.json();

            // Đổ dữ liệu vào form
            editGroupIdInput.value = data.id;
            editGroupNameInput.value = data.name;
            editGroupMaxInput.value = data.max;
            editGroupMandatoryInput.checked = data.mandatory;

            editOptionsContainer.innerHTML = '';
            if (data.options && data.options.length > 0) {
                data.options.forEach(opt => editOptionsContainer.appendChild(createEditOptionRow(opt)));
            } else {
                editOptionsContainer.appendChild(createEditOptionRow());
            }
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu nhóm tùy chọn:", error);
            editOptionsContainer.innerHTML = `<div class="alert alert-danger">Không thể tải dữ liệu. Vui lòng thử lại.</div>`;
        }
    });

    // --- 4. Sự kiện cho nút "Thêm Lựa Chọn Khác" ---
    addAnotherOptionBtn.addEventListener('click', () => {
        editOptionsContainer.appendChild(createEditOptionRow());
    });

    // --- 5. Lắng nghe sự kiện khi SUBMIT FORM (Gửi dữ liệu đi) ---
    editForm.addEventListener('submit', function(event) {
    // Ngăn trình duyệt tải lại trang, chúng ta sẽ xử lý bằng JavaScript
    event.preventDefault();

    // ----- A. THU THẬP DỮ LIỆU -----

    // Thu thập tất cả các lựa chọn (options) từ các thẻ đã tạo
    let optionsPayload = [];
    editOptionsContainer.querySelectorAll('.option-card').forEach(card => {
        const name = card.querySelector('.edit-option-name').value.trim();
        const price = parseFloat(card.querySelector('.edit-option-price').value) || 0;

        // Chỉ thêm vào danh sách nếu người dùng đã nhập tên
        if (name) {
            optionsPayload.push({ name: name, price: price });
        }
    });

    // Đóng gói toàn bộ dữ liệu (payload) để gửi đến server
    const payload = {
        id: parseInt(editGroupIdInput.value),
        name: editGroupNameInput.value.trim(),
        max: editGroupMaxInput.value ? parseInt(editGroupMaxInput.value) : null,
        mandatory: editGroupMandatoryInput.checked,
        options: optionsPayload
    };

    // ----- B. KIỂM TRA DỮ LIỆU -----
    if (!payload.name || !payload.id) {
        alert("Có lỗi xảy ra: Tên nhóm hoặc ID không hợp lệ.");
        return;
    }

    // ----- C. GỬI DỮ LIỆU ĐẾN API -----
    fetch('/api/option-group/update', { // API này chúng ta sẽ tạo ở backend
        method: 'POST', // Phương thức là POST vì chúng ta đang gửi dữ liệu để cập nhật
        headers: {
            'Content-Type': 'application/json', // Báo cho server biết chúng ta đang gửi JSON
        },
        body: JSON.stringify(payload) // Chuyển đối tượng JavaScript thành một chuỗi JSON
    })
    .then(res => res.json()) // Chuyển đổi phản hồi từ server thành JSON
    .then(result => {
        // ----- D. XỬ LÝ KẾT QUẢ -----
        if (result.success) {
            alert('✅ ' + (result.message || 'Cập nhật thành công!'));
            // Tải lại trang là cách đơn giản nhất để thấy thay đổi
            location.reload();
        } else {
            alert('❌ Lỗi: ' + (result.message || 'Không thể cập nhật.'));
        }
    })
    .catch(error => {
        // Bắt lỗi nếu có vấn đề về mạng
        console.error("Lỗi khi gửi form sửa:", error);
        alert('❌ Đã xảy ra lỗi mạng. Vui lòng thử lại.');
    });
});

});
</script>
<script>
    const deleteBtnInsideForm = document.getElementById('deleteGroupInsideFormBtn');


// === SỰ KIỆN KHI CLICK VÀO NÚT "XÓA" BÊN TRONG FORM ===
deleteBtnInsideForm.addEventListener('click', function() {

    // Lấy ID và tên của nhóm đang được sửa từ các ô input
    const groupId = editGroupId.value;
    const groupName = editGroupName.value.trim();

    // Nếu không có ID, không làm gì cả (để phòng lỗi)
    if (!groupId) {
        alert("Không thể xác định nhóm cần xóa.");
        return;
    }

    // Hiển thị hộp thoại xác nhận
    if (confirm(`Bạn có chắc chắn muốn xóa vĩnh viễn nhóm "${groupName}" không?`)) {

        // Gọi API xóa (API này bạn đã tạo ở bước trước)
        fetch(`/api/option-group/delete/${groupId}`, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                alert('✅ ' + result.message);


                // Tải lại trang để cập nhật danh sách
                location.reload();
            } else {
                alert('❌ Lỗi: ' + result.message);
            }
        })
        .catch(error => {
            console.error("Lỗi khi gửi yêu cầu xóa từ trong form:", error);
            alert('❌ Đã xảy ra lỗi mạng.');
        });
    }
});
</script>

<script>
    //THÊM NHÓM MÓN ĂN
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('modal_dishgroup');
    const openBtn = document.getElementById('btn_open_modal_dishgroup');
    const closeBtn = modal.querySelector('.close-modal');
    const overlay = modal.querySelector('.modal-overlay');
    const form = document.getElementById('form_add_dishgroup');

    if (!modal || !openBtn || !closeBtn || !overlay || !form) {
        console.warn('Không tìm thấy phần tử cần thiết cho modal.');
        return;
    }

    // Mở modal
    openBtn.addEventListener('click', () => {
        modal.classList.add('show');
        modal_dishgroup.style.display = 'flex';
    });


    // Đóng modal khi click X hoặc overlay
    const closeModal = () => modal.classList.remove('show');
    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    // Gửi form thêm nhóm món
    form.addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
console.log('Dữ liệu gửi lên server:', data);

        fetch('/add_dishgroup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                alert('✅ Thêm nhóm món thành công!');
                location.reload();
            } else {
                alert('❌ Thêm thất bại: ' + result.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('❌ Có lỗi xảy ra!');
        });
    });
});

</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-delete-group').forEach(btn => {
            btn.addEventListener('click', () => {
                const groupId = btn.dataset.id;

                if (confirm('Bạn có chắc chắn muốn xoá nhóm món này?')) {
                    fetch(`/delete_dishgroup/${groupId}`, {
                        method: 'DELETE'
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            alert('✅ Đã xoá nhóm món!');
                            location.reload();
                        } else {
                            alert('❌ Xoá thất bại: ' + result.message);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('❌ Lỗi khi xoá nhóm món!');
                    });
                }
            });
        });
    });
</script>
<script>
    //THÊM MÓN ĂN
  document.querySelectorAll('.add-dish-btn').forEach(button => {
  button.addEventListener('click', () => {
    const modal = document.getElementById('modal_add_dish');
    const groupId = button.getAttribute('data-group-id');
    document.getElementById('dish_group_id_input').value = groupId;
    const form = document.getElementById('form_add_dish');
    const closeBtn = modal.querySelector('.close-modal');
    const overlay = modal.querySelector('.modal-overlay');
    form.reset();

        // Sau khi reset, gán lại giá trị cho trường ẩn
        document.getElementById('dish_group_id_input').value = groupId;
    const closeModal = () => modal.classList.remove('show');

    // 👇 Gắn ngay trong callback
    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    modal.classList.add('show');
   form.addEventListener('submit', function (e) {
  e.preventDefault(); // <-- Chặn form submit mặc định (GET)

  const formData = new FormData(form);

  fetch('/add_dish', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("✅ Thêm món ăn thành công!");
      modal.classList.remove('show');
      form.reset();
      location.reload();
    } else {
      alert("❌ Thất bại: " + data.message);
    }
  })
  .catch(err => {
    console.error("Lỗi:", err);
    alert("❌ Lỗi gửi dữ liệu");
  });
});

  });
});
//SỬA MÓN ĂN
document.querySelectorAll('.btn-add-to-cart').forEach(btn => {
    btn.addEventListener('click', async () => {
        const dishId = btn.dataset.id;
        const modal = document.getElementById('modal_edit_dish');
        const form = document.getElementById('form_edit_dish');

        // Reset form để xóa dữ liệu cũ và bỏ tick các checkbox
        form.reset();
        modal.classList.add('show');

        const optionsContainer = document.getElementById('edit-dish-options-container');
        optionsContainer.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</p>';

        try {
            // Gọi API để lấy dữ liệu chi tiết của món ăn
            const response = await fetch(`/api/dish-details/${dishId}`);
            if (!response.ok) throw new Error('Không thể tải dữ liệu.');
            const data = await response.json();

            // Điền dữ liệu cơ bản vào form
            form.querySelector('#edit_dish_id').value = data.id;
            form.querySelector('#edit_name').value = data.name;
            form.querySelector('#edit_description').value = data.description;
            form.querySelector('#edit_price').value = data.price;
            form.querySelector('#edit_group_id').value = data.dish_group_id;

            // Khôi phục lại HTML gốc của các checkbox
            optionsContainer.innerHTML = `
                {% for group in dish_option_group %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="option_group_ids"
                               value="{{ group.id }}"
                               id="edit-dish-option-{{ group.id }}">
                        <label class="form-check-label" for="edit-dish-option-{{ group.id }}">
                            {{ group.name }}
                        </label>
                    </div>
                {% endfor %}
            `;

            // Tick sẵn vào các checkbox đã được liên kết
            if (data.linked_option_group_ids && data.linked_option_group_ids.length > 0) {
                const linkedIds = new Set(data.linked_option_group_ids.map(String));
                form.querySelectorAll('input[name="option_group_ids"]').forEach(checkbox => {
                    if (linkedIds.has(checkbox.value)) {
                        checkbox.checked = true;
                    }
                });
            }

        } catch (error) {
            console.error(error);
            alert(error.message);
            modal.classList.remove('show');
        }
    });
});

// 2. Xử lý đóng modal
const editDishModal = document.getElementById('modal_edit_dish');
if (editDishModal) {
    editDishModal.querySelector('.close-modal').addEventListener('click', () => {
        editDishModal.classList.remove('show');
    });
    editDishModal.querySelector('.modal-overlay').addEventListener('click', () => {
        editDishModal.classList.remove('show');
    });
}

// 3. Xử lý submit form sửa
const editDishForm = document.getElementById('form_edit_dish');
if (editDishForm) {
    editDishForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/update_dish', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("✅ " + (data.message || "Đã cập nhật!"));
                location.reload();
            } else {
                alert("❌ Sửa thất bại: " + (data.message || "Lỗi không xác định."));
            }
        })
        .catch(err => {
            alert("❌ Lỗi hệ thống");
            console.error(err);
        });
    });
}
//XÓA MÓN ĂN
    document.querySelectorAll('.btn-delete-dish').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault(); // Ngăn form hoặc nút gây reload không cần thiết

        const dishId = btn.getAttribute('data-dish-id');
        const confirmDelete = confirm("🗑️ Bạn có chắc chắn muốn xóa món ăn này không?");

        if (confirmDelete) {
            fetch('/delete_dish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dish_id: dishId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("✅ Món ăn đã được xóa thành công!");
                    location.reload(); // hoặc bạn có thể remove phần tử khỏi DOM
                } else {
                    alert("❌ Không thể xóa: " + data.message);
                }
            })
            .catch(error => {
                console.error(error);
                alert("❌ Đã xảy ra lỗi khi xóa!");
            });
        }
    });
});

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const header = document.querySelector('header');
        const categoryNavbarWrapper = document.querySelector('.category-navbar-wrapper');

        if (!header || !categoryNavbarWrapper) {
            return;
        }

        // Lấy vị trí ban đầu của thanh category-navbar so với đầu trang
        const navbarOffsetTop = categoryNavbarWrapper.offsetTop;

        // Hàm để kiểm tra và ẩn/hiện header
        function toggleHeaderVisibility() {
            const scrollPosition = window.pageYOffset;

            if (scrollPosition >= navbarOffsetTop) {
                // Thêm một class để ẩn header đi
                header.classList.add('header-hidden');
            } else {
                header.classList.remove('header-hidden');
            }
        }

        window.addEventListener('scroll', toggleHeaderVisibility);

        toggleHeaderVisibility();
    });
</script>
{% endblock %}