<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/favorite_restaurant.css') }}"/>
</head>

{% extends 'layout/base.html' %}

{% block content %}
<div class="container my-5">
    <!-- Title and Search bar -->
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h1 class="d-flex align-items-center page-title">
                <i class="bi bi-heart-fill icon-heart me-3"></i>
                <span class="fw-bold">Nhà hàng yêu thích</span>
            </h1>
        </div>
        <div class="col-md-6">
            <div class="input-group search-box">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="favoriteSearchInput" class="form-control" placeholder="Tìm kiếm trong danh sách yêu thích...">
            </div>
        </div>
    </div>

    <!-- Favorite Restaurants List -->
    <div id="favoriteListContainer" class="row g-4">
        {% if favorite_restaurants %}
            {% for restaurant in favorite_restaurants %}
            <div class="col-md-6 col-lg-4 restaurant-item-wrapper">
                <div class="card restaurant-card h-100" data-search-name="{{ restaurant.restaurant_name | lower }}">
                    <img src="{{ restaurant.image }}" class="card-img-top" alt="{{ restaurant.restaurant_name }}">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-3">{{ restaurant.restaurant_name }}</h5>
                        <div class="info-line star-rating">
                            <i class="bi bi-star-fill"></i>
                            <span>{{ restaurant.star_average or 'Mới' }} ({{ restaurant.reviews | length }}+ đánh giá)</span>
                        </div>
                        <div class="info-line">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>{{ restaurant.address }}</span>
                        </div>
                        <div class="info-line">
                            <i class="bi bi-clock-fill"></i>
                            <span>Mở cửa: {{ restaurant.open_time.strftime('%H:%M') if restaurant.open_time else 'N/A' }} - {{ restaurant.close_time.strftime('%H:%M') if restaurant.close_time else 'N/A' }}</span>
                        </div>
                        <div class="mt-auto d-grid gap-2 d-sm-flex">
                            <a href="{{ url_for('restaurant_detail', restaurant_id=restaurant.id) }}" class="btn btn-menu flex-sm-fill">Xem menu</a>
                            <button class="btn btn-unfavorite flex-sm-fill" data-restaurant-id="{{ restaurant.id }}">Gỡ khỏi yêu thích</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Hiển thị khi không có nhà hàng yêu thích nào -->
            <div class="col-12">
                <div class="text-center p-5 border rounded bg-light">
                    <i class="bi bi-heartbreak" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3">Bạn chưa có nhà hàng yêu thích nào</h4>
                    <p class="text-muted">Hãy khám phá và thêm các nhà hàng bạn thích vào danh sách nhé!</p>
                    <a href="{{ url_for('search') }}" class="btn btn-primary mt-2">Tìm kiếm nhà hàng</a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-- Trong file templates/favorite_restaurant.html -->

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('favoriteSearchInput');
    const listContainer = document.getElementById('favoriteListContainer');
    const allCards = listContainer.querySelectorAll('.restaurant-item-wrapper');

    // --- Chức năng tìm kiếm real-time (giữ nguyên) ---
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        allCards.forEach(cardWrapper => {
            const card = cardWrapper.querySelector('.restaurant-card');
            const restaurantName = card.dataset.searchName || '';
            if (restaurantName.includes(searchTerm)) {
                cardWrapper.style.display = '';
            } else {
                cardWrapper.style.display = 'none';
            }
        });
    });

    // --- Chức năng "Gỡ khỏi yêu thích" với Modal (ĐÃ SỬA LỖI) ---
    const confirmationModalElement = document.getElementById('confirmationModal');
    // Kiểm tra xem modal có tồn tại không trước khi khởi tạo
    if (confirmationModalElement) {
        const confirmationModal = new bootstrap.Modal(confirmationModalElement);
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const confirmationModalBody = document.getElementById('confirmationModalBody');

        let restaurantIdToUnfavorite = null;

        // SỰ KIỆN 1: Khi click nút "Gỡ khỏi yêu thích" trên card
        listContainer.addEventListener('click', function(event) {
            const unfavoriteBtn = event.target.closest('.btn-unfavorite');
            if (!unfavoriteBtn) return;

            // Chỉ lưu ID và mở Modal
            restaurantIdToUnfavorite = unfavoriteBtn.dataset.restaurantId;
            if (!restaurantIdToUnfavorite) return;

            confirmationModalBody.textContent = 'Bạn có chắc muốn gỡ nhà hàng này khỏi danh sách yêu thích?';
            confirmationModal.show();
        });

        // SỰ KIỆN 2: Gán sự kiện cho nút "Đồng ý" trong Modal MỘT LẦN DUY NHẤT
        if (confirmActionBtn) {
            confirmActionBtn.addEventListener('click', function() {
                if (!restaurantIdToUnfavorite) return;

                this.disabled = true;
                this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...`;

                fetch(`/api/toggle-favorite/${restaurantIdToUnfavorite}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.status === 'removed') {
                        const cardWrapperToRemove = listContainer.querySelector(`.btn-unfavorite[data-restaurant-id="${restaurantIdToUnfavorite}"]`).closest('.restaurant-item-wrapper');
                        if (cardWrapperToRemove) {
                            cardWrapperToRemove.style.transition = 'opacity 0.5s';
                            cardWrapperToRemove.style.opacity = '0';
                            setTimeout(() => {
                                cardWrapperToRemove.remove();
                                // Kiểm tra xem còn card nào không
                                if (listContainer.querySelectorAll('.restaurant-item-wrapper').length === 0) {
                                    // Nếu không còn, hiển thị lại thông báo "danh sách trống"
                                    listContainer.innerHTML = `
                                        <div class="col-12">
                                            <div class="text-center p-5 border rounded bg-light">
                                                <i class="bi bi-heartbreak" style="font-size: 4rem; color: #ccc;"></i>
                                                <h4 class="mt-3">Bạn chưa có nhà hàng yêu thích nào</h4>
                                                <p class="text-muted">Hãy khám phá và thêm các nhà hàng bạn thích vào danh sách nhé!</p>
                                                <a href="{{ url_for('search') }}" class="btn btn-primary mt-2">Tìm kiếm nhà hàng</a>
                                            </div>
                                        </div>`;
                                }
                            }, 500);
                        }
                        confirmationModal.hide();
                    } else {
                        alert('Lỗi: ' + (data.message || 'Không thể gỡ khỏi yêu thích.'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã có lỗi mạng xảy ra.');
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = 'Đồng ý';
                    restaurantIdToUnfavorite = null;
                });
            });
        }
    }
});
</script>
{% endblock %}